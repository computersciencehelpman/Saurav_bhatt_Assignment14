<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="'Channel - ' + ${channel.name}">Channel</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="container">
    <div class="header">
        <h1 th:text="${channel.name}">Channel Name</h1>
    </div>

    <!-- Message List -->
    <div id="messageList" class="message-display">
        <!-- Messages will be dynamically loaded here -->
    </div>

    <!-- Send Message Form -->
    <form id="sendMessageForm" method="post" th:action="@{'/channel/' + ${channel.name} + '/send'}">
        <input type="text" name="content" placeholder="Type your message..." required>
        <button type="submit">Send</button>
    </form>
</div>

<script>
// Load messages every second
setInterval(function() {
    const currentChannel = /*[[${channel.name}]]*/ 'general'; // fallback if Thymeleaf fails
    fetch('/channel/' + currentChannel + '/messages')
        .then(response => response.json())
        .then(messages => {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = ''; // Clear before re-rendering
            messages.forEach(msg => {
                const currentUser = sessionStorage.getItem("currentUser");
                const isSentByCurrentUser = (msg.fromUser === currentUser);

                const columnDiv = document.createElement('div');
                columnDiv.className = 'message-column ' + (isSentByCurrentUser ? 'sent' : 'received');

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble ' + (isSentByCurrentUser ? 'sent' : 'received');
                bubbleDiv.innerHTML = `
                    <div class="avatar">${msg.fromUser || 'Anonymous'}</div>
                    <div>${msg.content}</div>
                    <div class="timestamp">${formatTime(msg.timestamp)}</div>
                `;

                columnDiv.appendChild(bubbleDiv);
                messageList.appendChild(columnDiv);
            });
            messageList.scrollTop = messageList.scrollHeight; // Scroll to latest message
        });
}, 1000);

// Format timestamp nicely
function formatTime(timestamp) {
    if (!timestamp) return "";
    const date = new Date(timestamp);
    return date.getHours().toString().padStart(2, '0') + ':' +
           date.getMinutes().toString().padStart(2, '0');
}
</script>

</body>
</html>
